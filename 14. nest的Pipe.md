#### ä»€ä¹ˆæ˜¯`Pipe`

`Pipe` ç»å¸¸è¢«ç”¨æ¥å¤„ç†ä½¿ç”¨è€…ä¼ å…¥çš„å‚æ•°ï¼Œæ¯”å¦‚ï¼šéªŒè¯å‚æ•°çš„æ­£ç¡®æ€§ï¼Œç±»å‹è½¬æ¢ç­‰ã€‚

åœ¨`nest`ä¸­ï¼Œ`Pipe`æ”¯æ´`Exception`çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå½“åœ¨`Pipe`ä¸­æŠ›å‡º`Exception`æ—¶ï¼Œè¯¥æ¬¡è¯·æ±‚å°±ä¸ä¼šè¿›å…¥`Controller`å¯¹åº”çš„æ–¹æ³•é‡Œï¼Œè¿™æ ·çš„è®¾è®¡æ–¹æ³•èƒ½å¤Ÿæœ‰æ•ˆçš„éš”ç¦»éªŒè¯ç¨‹åºä¸ä¸»ç¨‹åºã€‚

![pipe](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe.drawio.png)



#### `nest` å†…ç½®çš„`Pipe`

`nest`å†…ç½®äº†ä»¥ä¸‹å‡ ä¸ª`Pipe`æ¥è¾…åŠ©ç±»å‹è½¬æ¢ä»¥åŠéªŒè¯ï¼š

| åç§°               | è¯´æ˜                                                   |
| ------------------ | ------------------------------------------------------ |
| `ValidationPipe`   | ä¸€èˆ¬ç”¨äºå…¨å±€çš„æ ¡éªŒç®¡é“                                 |
| `ParseIntPipe`     | è½¬æ¢ä¸ºæ•´æ•°ç±»å‹                                         |
| `ParseFloatPipe`   | è½¬ä¸ºæµ®ç‚¹æ•°                                             |
| `ParseBoolPipe`    | è½¬å¸ƒå°”å€¼                                               |
| `ParseArrayPipe`   | è½¬æ•°ç»„                                                 |
| `ParseUUIDPipe`    | è½¬uuid                                                 |
| `ParseEnumPipe`    | è½¬ä¸ºæšä¸¾                                               |
| `DefaultValuePipe` | é»˜è®¤å€¼ï¼Œé€‚ç”¨äºä¸€äº›å‚æ•°å¯ä»¥ä¸ä¼ ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªåŠ å…¥é»˜è®¤å€¼ |
| `ParseFilePipe`    | æ–‡ä»¶                                                   |



#### ä½¿ç”¨`Pipe`

`Pipe`çš„ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œå‡è®¾è¦è§£æå¹¶éªŒè¯è·¯ç”±çš„å‚æ•°æ˜¯å¦ä¸º`Integer`çš„è¯ï¼Œåªéœ€è¦åœ¨`@Param`è£…é¥°å™¨ä¼ å…¥è·¯ç”±å‚æ•°åå¹¶å¸¦å…¥`ParseIntPipe`å³å¯ã€‚

ä»¥`app.controller.ts`ä¸ºä¾‹ï¼Œå¦‚æœ`id`è§£æåä¸ºæ•°å­—ï¼Œå°±ä¼šé€šè¿‡`AppService`å–çš„å¯¹åº”çš„æ•°æ®ï¼Œå¦åˆ™æŠ›å‡º`Exception`ï¼š

```tsx
import { Controller, Get, Param, ParseIntPipe } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get(':id')
  getUser(@Param('id', ParseIntPipe) id: number) {
    return this.appService.getHello(id);
  }
}
```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-error-success.png)



#### å†…ç½®`Pipe`è‡ªå®šä¹‰`HttpCode`

å‡è®¾ä½ éœ€è¦æ›´æ”¹é”™è¯¯çŠ¶æ€ç ï¼Œé‚£`ParseIntPipe`å°±å¿…é¡»å®ä¾‹åŒ–å¹¶ä¼ å…¥ç›¸å…³å‚æ•°ï¼Œä»¥`app.controller.ts`ä¸ºä¾‹ï¼Œæˆ‘å¸Œæœ›åœ¨å‡ºé”™çš„æ—¶å€™æ”¶åˆ°`HttpCode`æ˜¯`406`ï¼š

```tsx
import {
  Controller,
  Get,
  HttpStatus,
  Param,
  ParseIntPipe,
} from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get(':id')
  getUser(
    @Param(
      'id',
      new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }), // éœ€è¦å®ä¾‹åŒ–
    )
    id: number,
  ) {
    return this.appService.getHello(id);
  }
}
```

å‡ºé”™åå¾—åˆ°ï¼š

```tsx
{
    "message": "Validation failed (numeric string is expected)",
    "error": "Not Acceptable",
    "statusCode": 406
}
```



#### å†…ç½® `Pipe`è‡ªå®šä¹‰`Exception`

å‡è®¾ä½ éœ€è¦æ›´æ”¹é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨`exceptionFactory`è¿™ä¸ªå‚æ•°æ¥æŒ‡å®šäº§ç”Ÿçš„`Exception`ã€‚ä»¥`app.controller.ts`ä¸ºä¾‹ï¼š

```tsx
import {
  Controller,
  Get,
  NotAcceptableException,
  Param,
  ParseIntPipe,
} from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get(':id')
  getUser(
    @Param(
      'id',
      new ParseIntPipe({
        exceptionFactory: () => new NotAcceptableException('æ— æ³•è§£æä¸ºæ•°å­—'), // è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯
      }),
    )
    id: number,
  ) {
    return this.appService.getHello(id);
  }
}

```

å‡ºé”™åå¾—åˆ°ï¼š

```tsx
{
    "message": "æ— æ³•è§£æä¸ºæ•°å­—",
    "error": "Not Acceptable",
    "statusCode": 406
}
```



#### è‡ªå®šä¹‰`Pipe`

å¦‚æœä½ è§‰å¾—å†…ç½®çš„`Pipe`æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œ`nest`æ˜¯å…è®¸è‡ªå®šä¹‰`Pipe`çš„ã€‚äº‹å®ä¸Šï¼Œ`Pipe`å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰`@Injectable`è£…é¥°å™¨çš„`class`ï¼Œ ä¸è¿‡å®ƒè¦å»å®ç°`PipeTransform`è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å€ŸåŠ©`nest cli`åˆ›å»º`Pipe`:

```tsx
nest generate pipe <PIPE_NAME>
```

> æ³¨æ„ï¼š `<PIPE_NAME>`å¯ä»¥åŒ…å«è·¯å¾„ï¼Œä¾‹å¦‚ï¼š `pipes/parse-int`

è¿™é‡Œæˆ‘åˆ›å»ºä¸€ä¸ª`ParseIntPipe`åœ¨`pipes`æ–‡ä»¶å¤¹ä¸‹ï¼š

```bash
nest generate pipe pipes/parse-int
```

ä¸‹é¢æ˜¯åˆ›å»ºçš„æ–‡ä»¶å†…å®¹ï¼š

```tsx
import { ArgumentMetadata, Injectable, PipeTransform } from '@nestjs/common';

@Injectable()
export class ParseIntPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    return value;
  }
}

```

æˆ‘ä»¬çœ‹åˆ°ï¼Œ`ParseIntPipe` å®ç° `PipeTransform` æŠ½è±¡æ¥å£ï¼Œ`transform(value: any, metadata: ArgumentMetadata)`æ–¹æ³•å°±æ˜¯åšé€»è¾‘åˆ¤æ–­çš„åœ°æ–¹ï¼Œå…¶ä¸­`value`ä¸ºä¼ è¿›æ¥çš„å€¼ï¼Œ`metadata`ä¸ºå½“å‰æ­£åœ¨å¤„ç†çš„å‚æ•°å…ƒæ•°æ®ã€‚

æˆ‘ä»¬è°ƒæ•´ä¸‹`parse-int.pipe.ts`æ–‡ä»¶çš„é€»è¾‘ï¼Œç»è¿‡`parseInt`ä¹‹åçš„`value`æ˜¯å¦ä¸º`NaN`ï¼Œ å¦‚æœæ˜¯åˆ™æŠ›å‡º`NotAcceptableException`ï¼š

```tsx
import {
  ArgumentMetadata,
  Injectable,
  NotAcceptableException,
  PipeTransform,
} from '@nestjs/common';

@Injectable()
export class ParseIntPipe implements PipeTransform<string, number> {
  transform(value: string, metadata: ArgumentMetadata) {
    const integer = parseInt(value);
    if (isNaN(integer)) {
      throw new NotAcceptableException('æ— æ³•è§£æä¸ºæ•°å­—');
    }
    return integer;
  }
}

```

æ¥ç€ä¿®æ”¹`app.controller.ts`ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„`Pipe`ï¼š

```tsx
import { Controller, Get, Param } from '@nestjs/common';
import { AppService } from './app.service';
import { ParseIntPipe } from './pipes/parse-int/parse-int.pipe';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get(':id')
  getUser(@Param('id', ParseIntPipe) id: number) {
    return this.appService.getHello(id);
  }
}
```



#### `DTO`æ ¼å¼éªŒè¯

å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œæ•°æ®éªŒè¯ï¼Œé‚£è¯¥å¦‚ä½•åšï¼Ÿäº‹å®ä¸Šè¿™ä¸ªé—®é¢˜åªéœ€è¦ä½¿ç”¨`DTO`ã€`ValidationPipe`ã€`class-validator` ã€ `class-transformer`ï¼Œè¿™é‡Œå…ˆå®Œæˆå‰ç½®æ“ä½œï¼Œé€šè¿‡`npm` å®‰è£…`class-validator`å’Œ`class-transformer`ï¼š

```bash
npm install --save class-validator class-transformer
```

æ¥ç€æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`todo`æ¨¡å—å’Œæ§åˆ¶å™¨:

```bash
nest generate module features/todo
nest generate controller features/todo
```

æ¥ç€åœ¨`features/todo`ä¸‹æ–°å»º`dto`æ–‡ä»¶å¤¹å¹¶å»ºç«‹`create-todo.dto.ts`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```tsx
export class CreateTodoDto {
  public readonly title: string;
  public readonly description?: string;
}
```

æˆ‘å¸Œæœ›`title`çš„è§„åˆ™å¦‚ä¸‹ï¼š

- å¿…å¡«
- å¿…é¡»æ˜¯ `String`
- æœ€å¤§é•¿åº¦ä¸º20

`description`çš„è§„åˆ™å¦‚ä¸‹ï¼š

- å¿…å¡«
- å¿…é¡»æ˜¯`String`

å¦‚ä½•å®Œæˆè¿™ä¸ªè§„åˆ™å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨`class-validator`å°±å¯ä»¥åŠåˆ°ï¼Œä¸»è¦æ˜¯æ›¿è¿™äº›å±æ€§å¢åŠ ç‰¹å®šçš„è£…é¥°å™¨ï¼š

```tsx
import { IsNotEmpty, IsOptional, IsString, MaxLength } from 'class-validator';

export class CreateTodoDto {
  @MaxLength(20)
  @IsString()
  @IsNotEmpty()
  public readonly title: string;

  @IsString()
  @IsOptional()
  public readonly description?: string;
}

```

> æé†’ï¼š æ›´å¤šè£…é¥°å™¨è¯·æŸ¥çœ‹ [`class-validator`](https://github.com/typestack/class-validator) å®˜ç½‘ã€‚

æ¥ä¸‹æ¥åªéœ€è¦åœ¨èµ„æºä¸Šé€šè¿‡`@UsePipes`è£…é¥°å™¨ä¼ å…¥`ValidationPipe`å³å¯ï¼š

```tsx
import {
  Body,
  Controller,
  Post,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
// @UsePipes(ValidationPipe) // å¯¹å½“å‰æ•´ä¸ªControllerç”Ÿæ•ˆ
export class TodoController {
  @Post()
  @UsePipes(ValidationPipe) // åªä¼šåœ¨è¯¥æ–¹æ³•ä¸Šç”Ÿæ•ˆ
  create(@Body() dto: CreateTodoDto) {
    return {
      id: 1,
      ...dto,
    };
  }
}
```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto.png)

#### å…³é—­`DTO`è¯¦ç»†é”™è¯¯ä¿¡æ¯

é€šè¿‡å®ä¾‹åŒ–`ValidationPipe`ä¼ å…¥`disableErrorMessages`å‚æ•°å³å¯å…³é—­é”™è¯¯ä¿¡æ¯ï¼š

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-close-dto-msg.png)

#### è‡ªå®šä¹‰`Exception`

`Pipe`ä¸€æ ·å¯ä»¥é€šè¿‡`exceptionFactory`è‡ªå®šä¹‰`Exception`:

```tsx
import {
  Body,
  Controller,
  HttpStatus,
  NotAcceptableException,
  Post,
  UsePipes,
  ValidationError,
  ValidationPipe,
} from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
// @UsePipes(ValidationPipe) // å¯¹å½“å‰æ•´ä¸ªControllerç”Ÿæ•ˆ
export class TodoController {
  @Post()
  // @UsePipes(new ValidationPipe({ disableErrorMessages: true })) // åªä¼šåœ¨è¯¥æ–¹æ³•ä¸Šç”Ÿæ•ˆ
  @UsePipes(
    new ValidationPipe({
      exceptionFactory: (errors: ValidationError[]) => {
        return new NotAcceptableException({
          code: HttpStatus.NOT_ACCEPTABLE,
          message: 'æ ¼å¼é”™è¯¯ğŸ™…',
          errors,
        });
      },
    }),
  ) // åªä¼šåœ¨è¯¥æ–¹æ³•ä¸Šç”Ÿæ•ˆ
  create(@Body() dto: CreateTodoDto) {
    return {
      id: 1,
      ...dto,
    };
  }
}

```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-custom-exception.png)

#### è‡ªåŠ¨è¿‡æ»¤å±æ€§

ä»¥å‰é¢æ–°å¢çš„`Todo`ä¾‹å­æ¥è¯´ï¼Œå¯æ¥å—çš„å‚æ•°`title`å’Œ`description`ä¸¤ä¸ªï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¼ é€’äº†ï¼š

```tsx
{
  "title": "Test",
  "text": "Hello." // dto ä¸­æ²¡æœ‰è¿™ä¸ªå‚æ•°
}
```

æ¯«ä¸ç›¸å…³çš„`text`å‚æ•°è¿›æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™æƒ³è¦å¿«é€Ÿè¿‡æ»¤æ‰è¿™ç§æ— æ•ˆå‚æ•°è¯¥æ€ä¹ˆåšï¼Ÿé€šè¿‡`ValidationPipe`è®¾ç½®`whitelist`å³å¯ï¼Œå½“`whitelist`ä¸º`true`æ—¶ï¼Œä¼šè‡ªåŠ¨è¿‡æ»¤æ‰åœ¨`DTO`ä¸­æ²¡æœ‰ä»»ä½•è£…é¥°çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°±ç®—æœ‰è¯¥å±æ€§ä½†æ˜¯æ²¡æœ‰æ·»åŠ `class-validator`çš„è£…é¥°å™¨ä¹Ÿä¼šè¢«è§†ä¸ºæ— æ•ˆå±æ€§ã€‚

éªŒè¯ä¸€ä¸‹ï¼š

```tsx
import {
  Body,
  Controller,
  Post,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
export class TodoController {
  @Post()
  @UsePipes(new ValidationPipe({ whitelist: true }))
  create(@Body() dto: CreateTodoDto) {
    return {
      id: 1,
      ...dto,
    };
  }
}

```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto-filter-param.png)

å¦‚æœæƒ³è¦ä¼ é€æ— æ•ˆå‚æ•°çš„æ—¶å€™ç›´æ¥æŠ¥é”™ï¼Œåˆ™æ˜¯åŒæ—¶ä½¿ç”¨`whitelist`å’Œ`forbidNonWhitelisted`ï¼š

```tsx
import {
  Body,
  Controller,
  Post,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
export class TodoController {
  @Post()
  @UsePipes(new ValidationPipe({ whitelist: true, forbidNonWhitelisted: true }))
  create(@Body() dto: CreateTodoDto) {
    return {
      id: 1,
      ...dto,
    };
  }
}

```

å¾—åˆ°ç»“æœï¼š

```tsx
{
    "message": [
        "property text should not exist"
    ],
    "error": "Bad Request",
    "statusCode": 400
}
```



#### è‡ªåŠ¨è½¬æ¢

`ValidationPipe`è¿˜æä¾›`transform`å‚æ•°æ¥è½¬æ¢ä¼ å…¥çš„æ•°æ®ï¼Œå°†å…¶å®ä¾‹åŒ–ä¸ºå¯¹åº”çš„`DTO`ï¼š

```tsx
import {
  Body,
  Controller,
  Post,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
export class TodoController {
  @Post()
  @UsePipes(new ValidationPipe({ transform: true }))
  create(@Body() dto: CreateTodoDto) {
    console.log(dto);
    return dto;
  }
}
```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto-transform.png)

`transform`è¿˜æœ‰ä¸€ä¸ªå¾ˆå‰å®³çš„åŠŸèƒ½ï¼Œè¿˜è®°å¾—å¦‚ä½•è·å–è·¯ç”±å‚æ•°å§ï¼Ÿå‡è®¾è·¯ç”±å‚æ•°è¦å–å¾—`id`ï¼Œè¿™ä¸ª`id`çš„ç±»å‹æ˜¯`number`ï¼Œä½†æ˜¯æ­£å¸¸æ¥è¯´ï¼Œè·¯ç”±å‚æ•°æ¥æ”¶åˆ°çš„æ—¶å€™éƒ½ä¼šæ˜¯`string`ï¼Œé€šè¿‡`transform`ï¼Œ`nest`ä¼šå°è¯•å»è½¬æ¢æˆæˆ‘ä»¬æŒ‡å®šçš„ç±»å‹ï¼š

```tsx
import {
  Controller,
  Get,
  Param,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';

@Controller('todos')
export class TodoController {
  @Get(':id')
  @UsePipes(new ValidationPipe({ transform: true }))
  get(@Param('id') id: number) {
    console.log(typeof id); // number
    return '';
  }
}
```



#### æ£€æµ‹æ•°ç»„`DTO`

å¦‚æœä¼ å…¥çš„æ•°æ®æ˜¯ä¸ªæ•°ç»„ï¼Œä¸èƒ½ä½¿ç”¨`ValidationPipe`ï¼Œè¦ä½¿ç”¨`ParseArrayPipe`ï¼Œå¹¶åœ¨`items`ä¼ å…¥å…¶`DTO`ï¼š

```tsx
import { Body, Controller, ParseArrayPipe, Post } from '@nestjs/common';
import { CreateTodoDto } from './dto/create-todo.dto';

@Controller('todos')
export class TodoController {
  @Post()
  create(
    @Body(new ParseArrayPipe({ items: CreateTodoDto }))
    dtos: CreateTodoDto[],
  ) {
    return dtos;
  }
}

```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto-array.png)

#### è§£ææŸ¥è¯¢å‚æ•°

`ParseArrayPipe`è¿˜å¯ä»¥ç”¨æ¥è§£ææŸ¥è¯¢å‚æ•°ï¼Œå‡è®¾æŸ¥è¯¢å‚æ•°ä¸º`?ids=1,2,3`ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥è§£æå„ä¸ª`id`ï¼Œåªéœ€è¦æ·»åŠ `separator`å»åˆ¤æ–­ä»¥ä»€ä¹ˆä½œä¸ºåˆ†ç•Œç‚¹ï¼š

```tsx
import { Controller, Get, ParseArrayPipe, Query } from '@nestjs/common';

@Controller('todos')
export class TodoController {
  @Get()
  get(
    @Query('ids', new ParseArrayPipe({ items: Number, separator: ',' }))
    ids: number[],
  ) {
    return ids;
  }
}
```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto-separator.png)

#### `DTO`æŠ€å·§

å½“ç³»ç»Ÿè¶Šæ¥è¶Šåºå¤§çš„æ—¶å€™ï¼Œ`DTO`çš„æ•°é‡ä¹Ÿä¼šéšä¹‹å¢åŠ ï¼Œæœ‰è®¸å¤šçš„`DTO`ä¼šæœ‰é‡å¤çš„å±æ€§ï¼Œä¾‹å¦‚ï¼š ç›¸åŒèµ„æºä¸‹çš„`CRUD DTO`ï¼Œè¿™æ—¶å€™å°±ä¼šå˜å¾—è¾ƒéš¾ç»´æŠ¤ï¼Œè¿˜å¥½`nest`æœ‰æä¾›è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œè¿ç”¨ç‰¹æ®Šçš„ç»§æ‰¿æ–¹å¼æ¥å¤„ç†ï¼š

##### å±€éƒ¨æ€§ä½¿ç”¨`Partial`

å±€éƒ¨æ€§ä½¿ç”¨çš„æ„æ€æ˜¯å°†å·²æœ‰çš„`DTO`å…¨éƒ¨å±æ€§è½¬æˆå¯é€‰ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨åˆ°`PartialType`å‡½æ•°æŠŠè¦ä½¿ç”¨çš„`DTO`ä¼ å…¥ï¼Œå¹¶ç»™åˆ°æ–°çš„`DTO`ç»§æ‰¿ã€‚ä¾‹å¦‚`update-todo.dto.ts`ï¼š

```tsx
// éœ€è¦å®‰è£… @nestjs/mapped-types: npm i @nestjs/mapped-types
import { PartialType } from '@nestjs/mapped-types';
import { CreateTodoDto } from './create-todo.dto';

export class UpdateTodoDto extends PartialType(CreateTodoDto) {}
```

å…¶æ•ˆæœç›¸å½“äºï¼š

```tsx
import { IsNotEmpty, IsOptional, IsString, MaxLength } from 'class-validator';

export class UpdateTodoDto {
  @MaxLength(20)
  @IsString()
  @IsNotEmpty()
  @IsOptional()
  public readonly title?: string;

  @IsString()
  @IsOptional()
  public readonly description?: string;
}
```

æ¥ç€ä¿®æ”¹`todo.controller.ts`:

```tsx
import {
  Body,
  Controller,
  Param,
  Patch,
  UsePipes,
  ValidationPipe,
} from '@nestjs/common';
import { UpdateTodoDto } from './dto/update-todo.dto';

@Controller('todos')
export class TodoController {
  @Patch(':id')
  @UsePipes(ValidationPipe)
  update(@Param('id') id: number, @Body() dto: UpdateTodoDto) {
    return {
      id,
      ...dto,
    };
  }
}
```

![](/Users/lynnlee/å­¦ä¹ åŒº/learn-nest/images/pipe-dto-partialType.png)

##### é€‰æ‹©æ€§ä½¿ç”¨`Pick`

é€‰æ‹©æ€§ä½¿ç”¨çš„æ„æ€æ˜¯åœ¨å·²æœ‰çš„`DTO`ä¸­é€‰æ‹©å“ªäº›ç”¨åˆ°çš„å±æ€§ï¼Œéœ€è¦ä½¿ç”¨åˆ°`PickType`å‡½æ•°æŠŠè¦ä½¿ç”¨çš„`DTO`ä¼ å…¥ä»¥åŠæŒ‡å®šè¦é€‰æ‹©çš„å±æ€§åç§°ï¼Œå¹¶ç»§æ‰¿ç»™æ–°çš„`DTO`ï¼š

```tsx
// éœ€è¦å®‰è£… @nestjs/mapped-types: npm i @nestjs/mapped-types
import { PickType } from '@nestjs/mapped-types';
import { CreateTodoDto } from './create-todo.dto';

export class UpdateTodoDto extends PickType(CreateTodoDto, ['title']) {}
```

å…¶æ•ˆæœç­‰åŒäºï¼š

```tsx
import { IsNotEmpty, IsString, MaxLength } from 'class-validator';

export class UpdateTodoDto {
  @MaxLength(20)
  @IsString()
  @IsNotEmpty()
  public readonly title: string;
}
```



##### å¿½ç•¥æ€§ä½¿ç”¨`Omit`

å¿½ç•¥æ€§ä½¿ç”¨çš„æ„æ€æ˜¯åœ¨å·²æœ‰çš„`DTO`ä¸­å»é™¤ä¸éœ€è¦ç”¨åˆ°çš„å±æ€§ï¼Œéœ€è¦ä½¿ç”¨åˆ°`OmitType`å‡½æ•°æŠŠè¦ä½¿ç”¨çš„`DTO`ä¼ å…¥ä»¥åŠæŒ‡å®šè¦å¿½ç•¥çš„å±æ€§åç§°ï¼Œå¹¶ç»§æ‰¿ç»™æ–°çš„`DTO`ï¼š

```tsx
// éœ€è¦å®‰è£… @nestjs/mapped-types: npm i @nestjs/mapped-types
import { OmitType } from '@nestjs/mapped-types';
import { CreateTodoDto } from './create-todo.dto';

export class UpdateTodoDto extends OmitType(CreateTodoDto,  ['title']) {
}
```

å…¶æ•ˆæœç­‰åŒäºï¼š

```tsx
import { IsOptional, IsString } from 'class-validator';

export class UpdateTodoDto {
  @IsString()
  @IsOptional()
  public readonly description?: string;
}
```



##### åˆå¹¶ä½¿ç”¨`Intersection`

åˆå¹¶ä½¿ç”¨çš„æ„æ€æ˜¯æŠŠå·²æœ‰çš„ä¸¤ä¸ª`DTO`åˆå¹¶åœ¨ä¸€èµ·ï¼Œéœ€è¦ä½¿ç”¨åˆ°`IntersectionType`å‡½æ•°æŠŠè¦ä½¿ç”¨çš„ä¸¤ä¸ª`DTO`ä¼ å…¥å¹¶ç»§æ‰¿ç»™æ–°çš„`DTO`ï¼š

```tsx
// éœ€è¦å®‰è£… @nestjs/mapped-types: npm i @nestjs/mapped-types
import { IntersectionType } from '@nestjs/mapped-types';
import { IsNotEmpty, IsString } from 'class-validator';
import { CreateTodoDto } from './create-todo.dto';

export class MockDto {
  @IsString()
  @IsNotEmpty()
  public readonly information: string;
}

export class UpdateTodoDto extends IntersectionType(CreateTodoDto, MockDto) {}
```

å…¶æ•ˆæœç­‰åŒäºï¼š

```tsx
import { IsNotEmpty, IsOptional, IsString, MaxLength } from 'class-validator';

export class UpdateTodoDto {
  @MaxLength(20)
  @IsString()
  @IsNotEmpty()
  public readonly title: string;

  @IsString()
  @IsOptional()
  public readonly description?: string;
  
  @IsString()
  @IsNotEmpty()
  public readonly information: string;
}
```



##### ç»„åˆåº”ç”¨

ä¸Šè¿°çš„å››ä¸ªå‡½æ•°ï¼š`PartialType`ã€`PickType`ã€`OmitType`ã€`IntersectionType`æ˜¯å¯ä»¥é€šè¿‡ç»„åˆçš„æ–¹å¼æ¥ä½¿ç”¨çš„ã€‚ä¸‹é¢çš„ç¤ºä¾‹å°†ä½¿ç”¨`OmitType`æŠŠ`CreateTodoDto`çš„`title`å»æ‰ï¼Œå¹¶ä½¿ç”¨`IntersectionType`æŠŠ`MockDto`åˆå¹¶ï¼š

```tsx
import { IntersectionType, OmitType } from '@nestjs/mapped-types';
import { IsNotEmpty, IsString } from 'class-validator';
import { CreateTodoDto } from './create-todo.dto';

export class MockDto {
    @IsString()
    @IsNotEmpty()
    public readonly information: string;
}

export class UpdateTodoDto extends IntersectionType(
    OmitType(CreateTodoDto, ['title']), MockDto
) {
}
```

å…¶æ•ˆæœç­‰åŒäº:

```
import { IsNotEmpty, IsOptional, IsString } from 'class-validator';

export class UpdateTodoDto {
  @IsString()
  @IsOptional()
  public readonly description?: string;
  
  @IsString()
  @IsNotEmpty()
  public readonly information: string;
}
```

#### å…¨å±€ `Pipe`

`ValidationPipe`ç®—æ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„åŠŸèƒ½ï¼Œå› ä¸ºå¤§å¤šæ•°çš„æƒ…å†µéƒ½ä¼šä½¿ç”¨åˆ°`DTO`çš„æ¦‚å¿µï¼Œå¦‚æ­¤ä¸€æ¥ä¾¿å¯ä»¥ä½¿ç”¨`DTO`éªŒè¯çš„æ–¹å¼å»æ£€æŸ¥æ•°æ®çš„æ­£ç¡®æ€§ï¼Œæ‰€ä»¥å¯ä»¥å°†`ValidationPipe`é…ç½®åœ¨å…¨å±€ã€‚é€šè¿‡`useGlobalPipes`æ–¹æ³•å°†`ValidationPipe`é€‚ç”¨äºå…¨å±€:

```tsx
import { ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // é…ç½®å…¨å±€Pipe
  app.useGlobalPipes(new ValidationPipe());
  
  await app.listen(3000);
}
bootstrap();
```

#### ä¾èµ–æ³¨å…¥å®ç°å…¨å±€`Pipe`

ä¸Šé¢çš„æ–¹æ³•æ˜¯é€šè¿‡æ¨¡å—å¤–éƒ¨å®Œæˆå…¨å±€é…ç½®çš„ï¼Œä¸ `Exception filter`ä¸€æ ·å¯ä»¥ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œé€šè¿‡æŒ‡å®š`Provider`çš„`token`ä¸º`APP_PIPE`æ¥å®ç°ï¼š

```tsx
import { Module, ValidationPipe } from '@nestjs/common';
import { APP_PIPE } from '@nestjs/core';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { TodoModule } from './features/todo/todo.module';

@Module({
  imports: [TodoModule],
  controllers: [AppController],
  providers: [
    AppService,
    // ä¾èµ–æ³¨å…¥
    {
      provide: APP_PIPE,
      useClass: ValidationPipe
    }
  ],
})
export class AppModule {}
```

> æ³¨æ„ï¼š è¿™é‡Œæ˜¯åœ¨`AppModule`ä¸­è¿›è¡Œå…¨å±€`Pipe`æ³¨å…¥ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œä½ åœ¨ä»»ä½•æ¨¡å—æ³¨å…¥éƒ½å¯ä»¥å®ç°å…¨å±€`Pipe`ã€‚
