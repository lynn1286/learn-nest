### ä»€ä¹ˆæ˜¯[è£…é¥°å™¨](https://www.typescriptlang.org/docs/handbook/decorators.html)

è£…é¥°å™¨æ¨¡å¼æ˜¯ä¸€ç§ç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹è¢«è£…é¥°è€…ï¼ˆå¦‚æŸä¸ªå‡½æ•°ã€æŸä¸ªç±»ç­‰ï¼‰æºç çš„å‰æä¸‹ï¼Œä¸ºè¢«è£…é¥°è€…å¢åŠ  / ç§»é™¤æŸäº›åŠŸèƒ½ï¼ˆæ”¶é›†ç”¨æˆ·å®šä¹‰çš„ç±»/å‡½æ•°çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨äºç”Ÿæˆè·¯ç”±è¡¨ï¼Œå®ç°ä¾èµ–æ³¨å…¥ç­‰ç­‰ã€ä¹Ÿå¯ä»¥å¯¹ç”¨æˆ·å®šä¹‰çš„ç±»/å‡½æ•°è¿›è¡Œå¢å¼ºï¼Œå¢åŠ é¢å¤–åŠŸèƒ½ï¼‰ã€‚

è£…é¥°å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä»¥è¢«è£…é¥°çš„æ„é€ ä¸ºå…¶å‚æ•°ï¼Œå¹¶å¯èƒ½è¿”å›ä¸€ä¸ªä¿®æ”¹åçš„æ„é€ æˆ–å…¨æ–°çš„æ„é€ ã€‚è£…é¥°å™¨å¯ä»¥ç”¨äºï¼š

- ä¿®æ”¹ç±»ã€æ–¹æ³•ã€è®¿é—®å™¨æˆ–å±æ€§çš„è¡Œä¸º
- å‘ç±»æˆ–æ–¹æ³•æ·»åŠ æ–°åŠŸèƒ½
- ä¸ºæ„é€ æä¾›å…ƒæ•°æ®
- å¼ºåˆ¶æ‰§è¡Œç¼–ç æ ‡å‡†æˆ–æœ€ä½³å®è·µ

`JavaScript` çš„åˆå§‹è£…é¥°å™¨ææ¡ˆäº 2014 å¹´æ¨å‡ºï¼Œè‡ªé‚£æ—¶èµ·ï¼Œå·²ç»å¼€å‘å‡ºäº†å‡ ä¸ªç‰ˆæœ¬çš„ææ¡ˆï¼Œå½“å‰ç‰ˆæœ¬å¤„äº `ECMAScript` æ ‡å‡†åŒ–è¿‡ç¨‹çš„[ç¬¬ä¸‰é˜¶æ®µ](https://devblogs.microsoft.com/typescript/announcing-typescript-5-0/#decorators)ã€‚



### è£…é¥°å™¨çš„è¯­æ³•

**è¦å¯ç”¨å¯¹è£…é¥°å™¨çš„å®éªŒæ€§æ”¯æŒï¼Œå¿…é¡»åœ¨** `experimentalDecorators` **å‘½ä»¤è¡Œæˆ–** `tsconfig.json` 

```json
{
  "compilerOptions": {
    "target": "ES2016",
    "experimentalDecorators": true
  }
}
```



è£…é¥°å™¨æ˜¯ä»¥ `@` ç¬¦å·ä¸ºå‰ç¼€çš„å‡½æ•°ï¼Œç´§æ¥ç€æ”¾ç½®åœ¨è¦ä¿®æ”¹çš„æ„é€ ä¹‹å‰ï¼š

```js
// è£…é¥°å™¨å‡½æ•°ç»™ç±»å¢åŠ é™æ€å±æ€§ã€åŸå‹æ–¹æ³•
const decoratorsFn = target => {
  target.age = 18;
  target.prototype.speak = function () {
    console.log('lynn');
  };
};

// è£…é¥°å™¨
@decoratorsFn
class People {}
```



### äº”ç§è£…é¥°å™¨

#### ç±»è£…é¥°å™¨ - Class Decorators

> ç±»è£…é¥°å™¨åœ¨ç±»å£°æ˜ä¹‹å‰å£°æ˜, ç±»è£…é¥°å™¨åº”ç”¨äºç±»çš„æ„é€ å‡½æ•°ï¼Œå¯ç”¨äºè§‚å¯Ÿã€ä¿®æ”¹æˆ–æ›¿æ¢ç±»å®šä¹‰ã€‚

- ç±»è£…é¥°å™¨çš„è¡¨è¾¾å¼å°†åœ¨è¿è¡Œæ—¶ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œè¢«è£…é¥°ç±»çš„æ„é€ å‡½æ•°å°†ä½œä¸ºå®ƒçš„å”¯ä¸€å‚æ•°ã€‚

```js
// constructor å‚æ•°æ˜¯ class A çš„æ„é€ å‡½æ•°
function decorateClass<T>(constructor: T) {
  console.log(constructor === A) // true
}

@decorateClass
class A {
  constructor() {}
}
```

- å¦‚æœç±»è£…é¥°å™¨è¿”å›ä¸€ä¸ªæ„é€ å‡½æ•°, å®ƒä¼šä½¿ç”¨æä¾›çš„æ„é€ å‡½æ•°æ¥æ›¿æ¢ç±»ä¹‹å‰çš„å£°æ˜ã€‚

```js
function decorateClass<T extends { new (...args: any[]): {} }>(constructor: T){
  return class B extends constructor{
    name = 'B'
  }
}

@decorateClass
class A {
  name = 'A'
  constructor() {}
}
console.log(new A().name)  // è¾“å‡º B
```



#### æ–¹æ³•è£…é¥°å™¨ - Method Decorators

> æ–¹æ³•è£…é¥°å™¨åœ¨æ–¹æ³•å£°æ˜ä¹‹å‰å£°æ˜ã€‚è£…é¥°å™¨å¯ä»¥åº”ç”¨äºæ–¹æ³•çš„å±æ€§æè¿°ç¬¦ï¼Œå¹¶å¯ç”¨äºè§‚å¯Ÿã€ä¿®æ”¹æˆ–æ›¿æ¢æ–¹æ³•å®šä¹‰ã€‚

- æ–¹æ³•è£…é¥°å™¨çš„è¡¨è¾¾å¼å°†åœ¨è¿è¡Œæ—¶ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œå¸¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°:

1. target: å½“å…¶è£…é¥°é™æ€æˆå‘˜æ—¶ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼Œè£…é¥°å®ä¾‹æˆå‘˜æ—¶ä¸ºç±»çš„åŸå‹å¯¹è±¡ã€‚

2. key: è¢«è£…é¥°çš„æ–¹æ³•åã€‚

3. descriptor: æˆå‘˜çš„å±æ€§æè¿°ç¬¦ å³ `Object.getOwnPropertyDescriptor(target,key)`ã€‚

```js
function decorateMethod(target: any, key: string, descriptor: PropertyDescriptor) {
  console.log('target === A', target === A) // æ˜¯å¦ç±»çš„æ„é€ å‡½æ•°
  console.log('target === A.prototype', target === A.prototype) // æ˜¯å¦ç±»çš„åŸå‹å¯¹è±¡
  console.log('key', key) // æ–¹æ³•å
  console.log('descriptor', descriptor) // æˆå‘˜çš„å±æ€§æè¿°ç¬¦ Object.getOwnPropertyDescriptor
}

class A {
  @decorateMethod
  static staticMethod() {}

  @decorateMethod
  instanceMethod() {}
}


// è¾“å‡º
target === A false
target === A.prototype true
key instanceMethod
descriptor {
  value: [Function: instanceMethod],
  writable: true,
  enumerable: false,
  configurable: true
}


target === A true
target === A.prototype false
key staticMethod
descriptor {
  value: [Function: staticMethod],
  writable: true,
  enumerable: false,
  configurable: true
}
```

- å¦‚æœæ–¹æ³•è£…é¥°å™¨è¿”å›ä¸€ä¸ªå€¼ï¼Œå®ƒä¼šè¢«ç”¨ä½œæ–¹æ³•çš„å±æ€§æè¿°ç¬¦ã€‚

```js
function decorateMethod(target: any, key: string, descriptor: PropertyDescriptor) {
  return {
    value: function (...args: any[]) {
      var result = descriptor.value.apply(this, args) * 2
      return result
    }
  }
}

class A {
  sum1(x: number, y: number) {
    return x + y
  }

  @decorateMethod
  sum2(x: number, y: number) {
    return x + y
  }
}

console.log(new A().sum1(1, 2)) // è¾“å‡º3
console.log(new A().sum2(1, 2)) // è¾“å‡º6 , decorateMethodè£…é¥°åï¼Œå…¶è¿”å›å€¼å‘ç”Ÿäº†å˜åŒ–
```



#### è®¿é—®å™¨è£…é¥°å™¨ - Accessor Decorators

> è®¿é—®å™¨è£…é¥°å™¨åœ¨è®¿é—®å™¨å£°æ˜ä¹‹å‰å£°æ˜ã€‚è®¿é—®å™¨è£…é¥°å™¨åº”ç”¨äºè®¿é—®å™¨çš„å±æ€§æè¿°ç¬¦ï¼Œå¹¶å¯ç”¨äºè§‚å¯Ÿã€ä¿®æ”¹æˆ–æ›¿æ¢è®¿é—®å™¨çš„å®šä¹‰ã€‚

- è®¿é—®å™¨è£…é¥°å™¨ä¸æ–¹æ³•è£…é¥°å™¨æœ‰è¯¸å¤šç±»ä¼¼ï¼Œæ¥å—3ä¸ªå‚æ•°ï¼š

1. target: å½“å…¶è£…é¥°é™æ€æˆå‘˜æ—¶ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼Œè£…é¥°å®ä¾‹æˆå‘˜æ—¶ä¸ºç±»çš„åŸå‹å¯¹è±¡ã€‚
2. key: è¢«è£…é¥°çš„æˆå‘˜åã€‚
3. descriptor: æˆå‘˜çš„å±æ€§æè¿°ç¬¦ å³ `Object.getOwnPropertyDescriptor(target,key)`ã€‚

```js
function configurable(target: any, key: string, descriptor: PropertyDescriptor) {
  descriptor.configurable = false
}

class A {
  _age = 18

  get age() {
    return this._age
  }

  @configurable
  set age(num: number) {
    this._age = num
  }
}
```

- å¦‚æœè®¿é—®å™¨è£…é¥°å™¨è¿”å›ä¸€ä¸ªå€¼ï¼Œå®ƒä¼šè¢«ç”¨ä½œè®¿é—®å™¨çš„å±æ€§æè¿°ç¬¦ã€‚

```js
function configurable(target: any, key: string, descriptor: PropertyDescriptor) {
  return {
    writable: false
  }
}

class A {
  _age = 18

  @configurable
  get age() {
    return this._age
  }

  set age(num: number) {
    this._age = num
  }
}

const a = new A()
a.age = 20 // æŠ›å‡º TypeError: Cannot assign to read only property 'age'

```



####  å±æ€§è£…é¥°å™¨ - Property Decorators 

> å±æ€§è£…é¥°å™¨åœ¨å±æ€§å£°æ˜ä¹‹å‰å£°æ˜ï¼Œè¿”å›å€¼ä¼šè¢«å¿½ç•¥ã€‚

- å±æ€§è£…é¥°å™¨çš„è¡¨è¾¾å¼å°†åœ¨è¿è¡Œæ—¶ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œå¸¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°:

1. target: å½“å…¶è£…é¥°é™æ€æˆå‘˜æ—¶ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼Œè£…é¥°å®ä¾‹æˆå‘˜æ—¶ä¸ºç±»çš„åŸå‹å¯¹è±¡ã€‚
2. key: è¢«è£…é¥°çš„æˆå‘˜åã€‚

```js
function decorateAttr(target: any, key: string) {
  console.log(target === A)
  console.log(target === A.prototype)
  console.log(key)
}

class A {
  @decorateAttr // è¾“å‡º true false staticAttr
  static staticAttr: any

  @decorateAttr // è¾“å‡º false true instanceAttr
  instanceAttr: any
}

```



####  å‚æ•°è£…é¥°å™¨ - Paramter Decorators

> å‚æ•°è£…é¥°å™¨åœ¨å‚æ•°å£°æ˜ä¹‹å‰å£°æ˜ï¼Œè¿”å›å€¼ä¼šè¢«å¿½ç•¥ã€‚

- å‚æ•°è£…é¥°å™¨çš„è¡¨è¾¾å¼å°†åœ¨è¿è¡Œæ—¶ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œå¸¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°:

1. target: å½“å…¶è£…é¥°é™æ€æˆå‘˜æ—¶ä¸ºç±»çš„æ„é€ å‡½æ•°ï¼Œè£…é¥°å®ä¾‹æˆå‘˜æ—¶ä¸ºç±»çš„åŸå‹å¯¹è±¡ã€‚
2. key: å‚æ•°åã€‚
3. index: å‚æ•°åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚

```js
function required(target: any, key: string, index: number) {
  console.log(target === A)
  console.log(target === A.prototype)
  console.log(key)
  console.log(index)
}

class A {
  saveData(@required name: string) {} // è¾“å‡º false true name 0
}

```



### è£…é¥°å™¨å·¥å‚

ä¸åŒç±»å‹è£…é¥°å™¨æœ¬èº«å‚æ•°æ˜¯å›ºå®šçš„ï¼Œåœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨ï¼Œå½“æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è£…é¥°å™¨å‚æ•°æ—¶ï¼Œä¾¿å¯ä»¥æ¥æ„é€ ä¸€ä¸ªè£…é¥°å™¨å·¥å‚å‡½æ•°ï¼Œå¦‚ä¸‹ä¾¿æ˜¯ä¸€ä¸ªå±æ€§è£…é¥°å™¨å·¥å‚å‡½æ•°ï¼Œæ”¯æŒè‡ªå®šä¹‰ä¼ å‚`name`ã€`age`ï¼š

```js
// ä¼ å‚å¹¶è¿”å›è£…é¥°å™¨
function decorateAttr(name: string, age: number) {
      return function (target: any, key: string) {
        Reflect.defineMetadata(key, {
          name, age
        }, target);
      }
}
```



### æ‰§è¡Œé¡ºåº

tsè§„èŒƒè§„å®š`è£…é¥°å™¨å·¥å‚å‡½æ•°ä»ä¸Šè‡³ä¸‹`å¼€å§‹æ‰§è¡Œï¼Œ`è£…é¥°å™¨å‡½æ•°ä»ä¸‹è‡³ä¸Š`å¼€å§‹æ‰§è¡Œ

```js
function first() {
  console.log("first(): factory evaluated");
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    console.log("first(): called");
  };
}

function second() {
  console.log("second(): factory evaluated");
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    console.log("second(): called");
  };
}

class ExampleClass {
  @first()
  @second()
  method() {}
}

è¾“å‡ºï¼š
first(): factory evaluated
second(): factory evaluated
second(): called
first(): called
```



### åº”ç”¨åœºæ™¯

1. é€»è¾‘å±‚æ¶ˆé™¤ç¹ççš„try/catchå—ï¼Œè£…é¥°å™¨å†…ç»Ÿä¸€è¾“å‡ºå‡½æ•°æ—¥å¿—

```js
function log(target: any, key: string, value: PropertyDescriptor) {
  return {
    value: async function (...args: any[]) {
      try {
        await value.value.apply(this, args)
      } catch (e) {
        console.log('ğŸš€ ~  : log -> ', e)
      }
    }
  }
}

class A {
  @log
  syncHandle() {
    // @ts-ignore
    return 3 + a
  }

  // @ts-ignore
  @log
  asyncHandle() {
    return Promise.reject('Async Error')
  }
}

new A().syncHandle()
new A().asyncHandle()

```

2. æ ¡éªŒå‚æ•°æˆ–è¿”å›å€¼ç±»å‹

```js
import 'reflect-metadata'

function validate() {
  return function (target: any, name: string, descriptor: PropertyDescriptor) {
    let set = descriptor.set
    descriptor.set = function (value) {
      let type = Reflect.getMetadata('design:type', target, name)
      console.log(type.name)
      if (!(new Object(value) instanceof type)) {
        throw new TypeError(`Invalid type, got ${typeof value} not ${type.name}.`)
      }
      set?.call(this, value)
    }
  }
}
class A {
  _age: number

  constructor() {
    this._age = 18
  }

  get age() {
    return this._age
  }

  @validate()
  set age(value: number) {
    this._age = value
  }
}
const a = new A()
a.age = 30
// @ts-ignore
a.age = '30' // æŠ›å‡º TypeError: Invalid type, got string not Number.


// tsconfig.json éœ€è¦å¼€å¯è£…é¥°å™¨å…ƒæ•°æ®
{
  "compilerOptions": {
    "target": "es2016",
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,
  }
}

```



### æ–‡çŒ®å‚è€ƒï¼š

https://github.com/microsoft/TypeScript/pull/50820

https://www.typescriptlang.org/docs/handbook/decorators.html
